# ssh

## Сервер

### Установка

На debian-подобных дистрибутивах установить ssh-сервер можно командой

```sh
apt-get install openssh-server
```

После установки в некоторых случаях нужно вручную стартануть ssh-сервер.

### Конфигурация

Конфиг сервера находится в файле `/etc/ssh/sshd_config`.
После обновление конфига нужно сделать рестарт сервера.

#### Отключение входа через пароль

Рекомендуется отключать вход по паролю. Это нужно, чтобы защититься от атаки перебора паролей.
Перед отключением входа по паролю нужно убедиться что настроены другие варианты доступа (например вход через ssh-ключ).
За парольный вход в конфиг файле отвечает директива `PasswordAuthentication`.
Соответственно отключённый парольный вход в конфиге выглядит так

```
PasswordAuthentication no
```

### Старт/рестарт сервера

В разных системах демон ssh-сервер может называться по разному: `ssh` или `sshd`.
Стартануть сервер можно командой

```sh
systemctl restart ssh
```

или командой

```sh
service ssh start
```

Для рестарта демона вместо аргумента `start` нужно использовать аргумент `restart`.

### Добавление публичного ключа клиента

Чтобы клиент мог подключаться к серверу по ssh не используя пароль нужно добавить публичный ключ клиента на сервер.
Публичный ключ клиента лежит на **клиентской** машине обычно в файле `~/.ssh/id_rsa.pub`.
Публичные ключи клиентов добавляются на **серверную** машину в файл `~/.ssh/authorized_keys`

Удобный способ добавить клиентский публичный ключ на сервер - это выполнение команды `ssh-copy-id` на клиентской машине.

```sh
ssh-copy-id <имя-пользователя-на-сервере>@<сервер>
```

## Клиент

### Создание нового ssh-ключа

Команда `ssh-keygen` без аргументов создаёт пару открытый/закрытый ключ в папке `~/.ssh`.
Файл закрытого ключа может называться `id_rsa` (для ключа созданного алгоритмом `rsa`),
а открытый ключ будет называться так же как закрытый, только с префиксом `.pub` (например `id_rsa.pub`).

#### Полезные флаги `ssh-keygen`

| Что               | Синтаксис                 | Пример        |
|-------------------|---------------------------|---------------|
| Алгоритм          | `-t <название-алгоритма>` | `-t rsa`      |
| Разрядность ключа | `-b <количество-бит>`     | `-b 4096`     |
| Файл нового ключа | `-f <путь/к/файлу>`       | `-f ./id_rsa` |

#### Права доступа к файлам ключей

Для безопасности файлы ключей должны иметь правильные настройки прав доступа.
Некоторые приложения могут даже отказаться работать с ключами если обнаружат небезопасные настройки.
Владельцем файлов приватного и публичного ключей должен быть текущий пользователь.
Права доступа должны быть как в таблице.

| Тип ключа | Файл         | Права доступа |
|-----------|--------------|---------------|
| Приватный | `id_rsa`     | `-rw-------`  |
| Публичный | `id_rsa.pub` | `-rw-r--r--`  |

### Подключение по ssh

```sh
ssh [<имя-пользователя-на-сервере>@]<сервер>
```

#### Полезные флаги `ssh`

| Что                                                          | Синтаксис                              | Пример                                 |
|--------------------------------------------------------------|----------------------------------------|----------------------------------------|
| Порт подключения                                             | `-p <номер-порта>`                     | `-p 22`                                |
| Файл приватного ключа                                        | `-i <путь/к/файлу>`                    | `-i ~/.ssh/id_rsa`                     |
| Принудительно включить/отключить аутентификацию по ssh-ключу | `-o PubkeyAuthentication=<yes/no>`     | `-o PubkeyAuthentication=no`           |
| Предпочтительный способ аутентификации                       | `-o PreferredAuthentications=<способ>` | `-o PreferredAuthentications=password` |

#### Файл `~/.ssh/known_hosts`

Файл хранится на клиентской машине. В каждой строчке прописана информация ровно об одном **известном** хосте.
Если ssh при подключении обнаружит что информация сервера изменилась с последнего раза, то выдаст ошибку.

Найти хост в `known_hosts`

```sh
ssh-keygen -F <сервер>
```

Удалить хост из `known_hosts`

```sh
ssh-keygen -R <сервер>
```

## Примеры

### Реверсивный прокси

Условие:

1. Есть два хоста. Назовём их **локальный** и **глобальный**.
1. **Локальный** - это хост без белого IP.
1. **Глобальный** - это хост с белым IP.
1. На **локальном** хосте запущен http-сервер на порту `8081`.
1. Нужно настроить прокси чтобы **глобальный** хост раздавал http на порту `80`
   проксируя порт `8081` **локального** хоста.

Решение:

Идём на **глобальный** хост настраивать конфигурацию ssh-сервера в файле

```sh
vi /etc/ssh/sshd_config
```

Устанавливаем опцию `GatewayPorts` в `yes`

```
GatewayPorts yes
```

Проверяем что нет ошибок в конфигурации.

```sh
/usr/sbin/sshd -t
```

Если будут ошибки - то команда выведет их в консоль, если нет - ничего не выведет.

Рестартуем ssh-сервер.

```sh
systemctl restart ssh.service
```

Идём на **локальный** хост и запускаем проксирование.
По сути это просто подключение на **глобальный** с **локального** по ssh, но с некоторыми флагами.

```sh
ssh -fN -R 80:127.0.0.1:8081 [имя-пользователя-на-глобальном-хосте@]<глобальный-хост>
```

Флаг `f` указывает что нужно запустить команду в фоне.
Флаг `N` запрещает в текущем ssh-подключении выполнение консольных команд.

Чтобы остановить проксирование, нужно завершить подключение по ssh (которое выполнили на прошлом шаге).
Для этого с помощью команды находим PID процесса

```sh
ps -aux | grep ssh
```

Делаем `kill` процессу

```sh
kill <PID-ssh-процесса>
```
